{% extends "core/base.html" %}

{% block content %}
<div class="container mt-5">

  <h2 class="text-center fw-bold mb-4">Tableau de bord conducteur</h2>
  <p class="text-center text-muted mb-4">Résumé de vos activités et gestion des trajets.</p>

  <!-- Statistiques -->
  <div class="row g-2 justify-content-center mb-4">
    <div class="col-6 col-sm-3 col-md-2 text-center">
      <div class="card py-2 px-1 rounded-3 shadow-sm border-0 bg-primary text-white">
        <div class="fw-bold small">Trajets actifs</div>
        <div class="fs-5 fw-semibold">{{ trajets_actifs_count }}</div>
      </div>
    </div>
    <div class="col-6 col-sm-3 col-md-2 text-center">
      <div class="card py-2 px-1 rounded-3 shadow-sm border-0 bg-secondary text-white">
        <div class="fw-bold small">Trajets archivés</div>
        <div class="fs-5 fw-semibold">{{ trajets_archives_count }}</div>
      </div>
    </div>
    <div class="col-6 col-sm-3 col-md-2 text-center">
      <div class="card py-2 px-1 rounded-3 shadow-sm border-0 bg-success text-white">
        <div class="fw-bold small">Réservations</div>
        <div class="fs-5 fw-semibold">{{ reservations_totales }}</div>
      </div>
    </div>
    <div class="col-6 col-sm-3 col-md-2 text-center">
      <div class="card py-2 px-1 rounded-3 shadow-sm border-0 bg-info text-white">
        <div class="fw-bold small">Avec réservations</div>
        <div class="fs-5 fw-semibold">{{ trajets_avec_reservations }}</div>
      </div>
    </div>
  </div>

  <!-- Trajets -->
  <h4 class="mb-3 border-bottom pb-2">Mes trajets en cours</h4>
  <div class="row">
    {% for info in trajets_avec_details %}
      {% with trajet=info.trajet %}
      <div class="col-12 col-md-6 mb-4 d-flex">
        <div class="card w-100 h-100 d-flex flex-column shadow-sm">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-primary fw-bold">{{ trajet.ville_depart }} → {{ trajet.ville_arrivee }}</h5>
            <p class="mb-1"><strong>Date :</strong> {{ trajet.date_heure_depart|date:"d/m/Y H:i" }}</p>
            <p class="mb-1"><strong>Places totales :</strong> {{ info.places_totales }}</p>
            <p class="mb-1"><strong>Réservées :</strong> {{ info.nombre_reservations }}</p>
            <p class="mb-3"><strong>Restantes :</strong> {{ info.places_restantes }}</p>

            {% if info.reservations %}
              <div class="mb-2 small">
                <h6 class="mb-1">Réservations :</h6>
                <ul class="list-group list-group-flush small">
                  {% for r in info.reservations %}
                    <li class="list-group-item px-2 py-1">
                      {{ forloop.counter }}. <strong>{{ r.nom }}</strong> - {{ r.telephone }}
                      {% if r.email %} - {{ r.email }}{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            <form method="post" class="mt-auto d-flex justify-content-between gap-1" onsubmit="return confirm('Êtes-vous sûr ?');">
              {% csrf_token %}
              <input type="hidden" name="trajet_id" value="{{ trajet.id }}">
              {% if info.modifiable %}
                <a href="{% url 'modifier_trajet' trajet.id %}" class="btn btn-outline-warning btn-sm w-50">
                  Modifier
                </a>
                <button type="submit" class="btn btn-outline-danger btn-sm w-50">
                  Supprimer
                </button>
              {% else %}
                <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
                  Annuler (non modifiable)
                </button>
              {% endif %}
            </form>
          </div>
        </div>
      </div>
      {% endwith %}
    {% empty %}
      <p class="text-center fst-italic mt-4">Aucun trajet enregistré pour le moment.</p>
    {% endfor %}
  </div>

</div>
{% endblock %}
